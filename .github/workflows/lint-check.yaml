name: Lint Check

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  lint:
    name: Lint Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run lint and check for warnings/errors
        id: lint-check
        run: |
          # Create a temporary file for lint output
          LINT_OUTPUT_FILE=$(mktemp)

          # Run lint and save output to file
          npm run lint -- --format=json > "$LINT_OUTPUT_FILE" 2>/dev/null || true

          # Initialize counters
          TOTAL_ERRORS=0
          TOTAL_WARNINGS=0

          # Check if file exists and has content
          if [ -s "$LINT_OUTPUT_FILE" ]; then
            # First check if the file contains valid JSON
            if jq -e . "$LINT_OUTPUT_FILE" >/dev/null 2>&1; then
              # Try to process as an array first
              if jq -e 'type == "array"' "$LINT_OUTPUT_FILE" >/dev/null; then
                TOTAL_ERRORS=$(jq -r '.[] | .errorCount // 0' "$LINT_OUTPUT_FILE" | awk '{s+=$1} END {print s+0}')
                TOTAL_WARNINGS=$(jq -r '.[] | .warningCount // 0' "$LINT_OUTPUT_FILE" | awk '{s+=$1} END {print s+0}')
              else
                # Process as a single object
                TOTAL_ERRORS=$(jq -r '.errorCount // 0' "$LINT_OUTPUT_FILE" 2>/dev/null || echo 0)
                TOTAL_WARNINGS=$(jq -r '.warningCount // 0' "$LINT_OUTPUT_FILE" 2>/dev/null || echo 0)
              fi
            fi
          fi

          # Convert to integers
          TOTAL_ERRORS=${TOTAL_ERRORS:-0}
          TOTAL_WARNINGS=${TOTAL_WARNINGS:-0}

          # Print summary
          echo "Lint results:"
          echo "Total errors: $TOTAL_ERRORS"
          echo "Total warnings: $TOTAL_WARNINGS"

          # Set outputs for the job
          echo "total_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
          echo "total_warnings=$TOTAL_WARNINGS" >> $GITHUB_OUTPUT

          # Fail the step if there are any errors
          if [ "$TOTAL_ERRORS" -gt 0 ]; then
            echo "::error::Lint check failed with $TOTAL_ERRORS error(s) and $TOTAL_WARNINGS warning(s)"
            exit 1
          elif [ "$TOTAL_WARNINGS" -gt 0 ]; then
            echo "::warning::Lint check passed with $TOTAL_WARNINGS warning(s)"
          else
            echo "Lint check passed with no errors or warnings"
          fi

      - name: Run build
        run: npm run build
        env:
          NODE_ENV: production
